name: ðŸ“¦ Release
on:
  push:
    tags: ["v*"]

jobs:
  linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install Linux Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev
    - uses: dAppServer/wails-build-action@main
      with:
        build-name: chip8-wails
        build-platform: linux/amd64
        package: false
        tags: webkit2_41
        wails-version: "v2.9.0"
    - name: Build AppImage
      run: wails generate appimage \
        -binary ./build/bin/chip8-wails \
        -icon build/linux/appicon.png \
        -desktop build/linux/app.desktop
    - name: Linux packages (deb/rpm)
      uses: goreleaser/goreleaser-action@v5
      with:
        args: release --rm-dist
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - uses: softprops/action-gh-release@v2
      with:
        files: dist/*.AppImage dist/*.deb dist/*.rpm

  windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    - uses: dAppServer/wails-build-action@main
      with:
        build-name: chip8-wails
        build-platform: windows/amd64
        package: false
        wails-version: "v2.9.0"
    - uses: actions/upload-artifact@v4
      with:
        name: chip8-wails-windows-exe
        path: build/bin/windows/chip8-wails.exe
    - uses: softprops/action-gh-release@v2
      with:
        files: build/bin/windows/chip8-wails.exe

  macos:
    runs-on: macos-14
    steps:
    - uses: actions/checkout@v4
    - uses: dAppServer/wails-build-action@main
      with:
        build-name: chip8-wails
        build-platform: darwin/universal
        package: false
        wails-version: "v2.9.0"
    - name: Install create-dmg
      run: brew install create-dmg
    - name: Build DMG
      run: create-dmg \
        --volname "chip8-wails" \
        --window-size 540 380 \
        --app-drop-link 380 120 \
        build/bin/darwin/chip8-wails.app
    - uses: softprops/action-gh-release@v2
      with:
        files: "*.dmg"
